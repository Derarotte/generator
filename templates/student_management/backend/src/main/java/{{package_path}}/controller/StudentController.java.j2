package {{ package_name }}.controller;

import {{ package_name }}.entity.Student;
import {{ package_name }}.service.StudentService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * 学生控制器
 * 
 * @author {{ author }}
 */
@RestController
@RequestMapping("/api/student")
@CrossOrigin
public class StudentController {
    
    @Autowired
    private StudentService studentService;
    
    /**
     * 获取学生列表
     */
    @GetMapping("/list")
    public Map<String, Object> list(@RequestParam(required = false) String keyword) {
        Map<String, Object> result = new HashMap<>();
        List<Student> students;
        
        if (keyword != null && !keyword.trim().isEmpty()) {
            students = studentService.search(keyword);
        } else {
            students = studentService.findAll();
        }
        
        result.put("code", 200);
        result.put("data", students);
        result.put("total", students.size());
        return result;
    }
    
    /**
     * 获取单个学生
     */
    @GetMapping("/{id}")
    public Map<String, Object> getById(@PathVariable Long id) {
        Map<String, Object> result = new HashMap<>();
        Student student = studentService.findById(id);
        
        if (student != null) {
            result.put("code", 200);
            result.put("data", student);
        } else {
            result.put("code", 404);
            result.put("message", "学生不存在");
        }
        return result;
    }
    
    /**
     * 新增/更新学生
     */
    @PostMapping("/save")
    public Map<String, Object> save(@RequestBody @Validated Student student) {
        Map<String, Object> result = new HashMap<>();
        
        try {
            // 检查学号是否重复（新增时）
            if (student.getId() == null && studentService.existsByStudentNo(student.getStudentNo())) {
                result.put("code", 400);
                result.put("message", "学号已存在");
                return result;
            }
            
            studentService.save(student);
            result.put("code", 200);
            result.put("message", student.getId() == null ? "新增成功" : "更新成功");
            result.put("data", student);
        } catch (Exception e) {
            result.put("code", 500);
            result.put("message", "保存失败: " + e.getMessage());
        }
        return result;
    }
    
    /**
     * 删除学生
     */
    @DeleteMapping("/{id}")
    public Map<String, Object> delete(@PathVariable Long id) {
        Map<String, Object> result = new HashMap<>();
        
        try {
            studentService.delete(id);
            result.put("code", 200);
            result.put("message", "删除成功");
        } catch (Exception e) {
            result.put("code", 500);
            result.put("message", "删除失败: " + e.getMessage());
        }
        return result;
    }
    
    /**
     * 批量删除
     */
    @PostMapping("/batchDelete")
    public Map<String, Object> batchDelete(@RequestBody List<Long> ids) {
        Map<String, Object> result = new HashMap<>();
        
        try {
            int count = studentService.batchDelete(ids);
            result.put("code", 200);
            result.put("message", "成功删除 " + count + " 条记录");
        } catch (Exception e) {
            result.put("code", 500);
            result.put("message", "批量删除失败: " + e.getMessage());
        }
        return result;
    }
    
    /**
     * 获取统计信息
     */
    @GetMapping("/stats")
    public Map<String, Object> stats() {
        Map<String, Object> result = new HashMap<>();
        result.put("code", 200);
        result.put("total", studentService.count());
        return result;
    }
}
